name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libxdo-dev libayatana-appindicator3-dev librsvg2-bin

      - uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release

      - name: Generate icons
        run: |
          mkdir -p icons
          for size in 16 32 48 64 128 256 512 1024; do
            rsvg-convert -w $size -h $size assets/icon.svg -o "icons/xshuttle-${size}.png"
          done
          cp assets/icon.svg icons/xshuttle.svg

      - name: Package
        run: |
          ARCHIVE="xshuttle-x86_64-unknown-linux-gnu"

          mkdir -p "$ARCHIVE/icons"
          cp target/release/xshuttle "$ARCHIVE/"
          cp extra/linux/xshuttle.desktop "$ARCHIVE/"
          cp extra/linux/xshuttle-autostart.desktop "$ARCHIVE/"
          cp icons/* "$ARCHIVE/icons/"

          tar czf "${ARCHIVE}.tar.gz" "$ARCHIVE"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xshuttle-x86_64-unknown-linux-gnu
          path: xshuttle-*.tar.gz

  build-macos:
    strategy:
      matrix:
        include:
          - target: x86_64-apple-darwin
            runner: macos-13
          - target: aarch64-apple-darwin
            runner: macos-14

    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: brew install librsvg

      - uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release

      - name: Generate icons
        run: |
          mkdir -p xshuttle.iconset
          for size in 16 32 128 256 512; do
            rsvg-convert -w $size -h $size assets/icon.svg -o "xshuttle.iconset/icon_${size}x${size}.png"
            double=$((size * 2))
            if [ $double -le 1024 ]; then
              rsvg-convert -w $double -h $double assets/icon.svg -o "xshuttle.iconset/icon_${size}x${size}@2x.png"
            fi
          done
          iconutil -c icns xshuttle.iconset -o xshuttle.icns

      - name: Package
        run: |
          ARCHIVE="xshuttle-${{ matrix.target }}"

          mkdir -p "$ARCHIVE"
          cp target/release/xshuttle "$ARCHIVE/"
          cp extra/macos/com.athopen.xshuttle.plist "$ARCHIVE/"
          cp xshuttle.icns "$ARCHIVE/"

          tar czf "${ARCHIVE}.tar.gz" "$ARCHIVE"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xshuttle-${{ matrix.target }}
          path: xshuttle-*.tar.gz

  release:
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/*.tar.gz
          generate_release_notes: true
